<!DOCTYPE html>
<html>
<head>
    <title>想做一个轻量级orm的组件</title>
</head>
<body>

    <h1 id="orm">想做一个轻量级orm的组件</h1>
<ul>
<li>先说下公司背景，一家传统的企业，有自己的erp，系统非常的老，基本十年了。</li>
<li>Erp从技术上来说，使用net技术，b/s架构，编译器从vs2005升级到vs2010，技术采用早期的aspx技术，</li>
<li>使用ado连接Sqlserver 。此系统经过最少三波人的开发，所以还有不下三种诸如Linq的访问方式。</li>
<li>系统中的sql基本靠手写，完全不警惕注入的问题。</li>
<li>没有冲突检测机制，数据有重复插入问题，只有一些重要模块采用了事务。</li>
<li>软件架构方面，系统基本没有任何分层体系，属于典型业务堆积而成的代码。</li>
</ul>
<hr />
<ul>
<li>再说下我，我的职责是负责企业内部软件的总体架构，</li>
<li>第一步就是处理数据库，这块是整合业务的核心。</li>
<li>因为自己不太喜欢手写的方式,而此前一直使用entity framework</li>
<li>使用的越久，越不满意ef，</li>
<li>并且考虑到现公司维护erp的程序员的情况，所以总体上还是采用sql得方式，</li>
<li>唯一有所变化的是会有一个较好的数据库访问模式。</li>
</ul>
<hr />
<p>整理了下思路，必须符合以下特征</p>
<ol>
<li>控制更新，删除，新增操作 (一致性 ，冲突检测)</li>
<li>解决sql注入的问题</li>
<li>添加底层机制，对重要数据添加痕迹功能(暂时定义为操作记录保存到另一张表)</li>
<li>方便的事物机制</li>
<li>对于复杂的查询sql采用手写的方式 原因在于复杂的语句有限，并且可能产生一些临时表，而orm自动产生得语句大多令人失望，特别是语句一定会遇到优化调整，使用索引，orm生成的语句基本属于黑盒子，只能前期用用</li>
<li>数据上有同一的创建/更新者信息</li>
<li>具备一定的列唯一值的检测 (后期发现这条没啥用 尴尬了)</li>
</ol>
<hr />
<blockquote>
<p>外面得框架，大多是orm，并且使用类似linq表达式，基本放弃。
也有一些类似秋色园博主的数据库访问组件，但是缺少了一些特性，并且考虑到适合的问题，所以还是自己开发一套。caoz
因为只做对数据库DML那块功能,所以时间上会很短。不必担心太多的问题。
结合实际情况，数据库上基本使用Sqlserver 且不变化，采用非常高效的dapper组件，它支持查询对象化。
准备在其上封装一层，基于2/8原则，生成一部分的Sqlserver的语句，让整体拥有伪orm的功能，
复杂的功能还是采用dapper组件处理。
这样随时保持着可以使用原生sql的能力，一些简单的重复性的代码基本使用封装好的组件。</p>
</blockquote>
<hr />
<blockquote>
<p>封装出来的组件我叫它DapperHelper。它只控制update/delete/add的操作。其他的查询语句基本需要手写，单表除外.
对于复杂的查询语句，我认为这是一个长期优化的事情，不是一蹴而就的，特别是一些全文检索的语句，单纯靠orm的框架去生成，效率太低。
而且对于多表链接的问题，如果链接的太多，要么业务有问题，要么语句有问题，整体还是不断优化的.</p>
</blockquote>
<p>2017/07/27 21:51</p>


</body>
</html>